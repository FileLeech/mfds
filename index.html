<html>
<head>
<title>Multi-Filehoster-Leech</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<script type="text/javascript" src="DownloadModel.js"></script>
<script type="text/javascript">

	var http = createRequestObject();
	var dlStarted = false;
	var dlComplete = false;
	var dlAborted = false;
	var dlLink;
	//var downloads[0].id;
	var debug = true;
	
	var downloading = false;
	var activeDownload = null;
	var queue = new Array();
	var finishedDownloads = new Array();
	
	
	function addDownload(){
		var link = document.getElementById("linkinput").value;
		var dl = new DownloadModel(link);
		dl.progress = 0 ;
		if(activeDownload == null) {
			activeDownload = dl;
			sendDownloadRequest(link);
		}
		else{
			queue.push(dl);
		}
	}

	

	function createRequestObject() {
		var objAjax;
		var browser = navigator.appName;
		if(browser == "Microsoft Internet Explorer"){
			objAjax = new ActiveXObject("Microsoft.XMLHTTP");
		}else{
			objAjax = new XMLHttpRequest();
		}
		return objAjax;
	}
	

	function statusRequestLoop() {
		if(activeDownload.complete) {
			sendFinishRequest();
			finishedDownloads.push(activeDownload);

			if(queue.length != 0){
				activeDownload = queue.shift();
				sendDownloadRequest(activeDownload.link);
				displayTable();
				return;
			}
			else{
				activeDownload = null;
				displayTable();
				return;
			}
		}
	
		if(activeDownload.aborted) {
			if(queue.length != 0){
				activeDownload = queue.shift();
				sendDownloadRequest(activeDownload.link);
				displayTable();
				return;
			}
			else{
				activeDownload = null;
				displayTable();
				return;
			}
		}
	
		
				
		setTimeout('statusRequestLoop()',500);
		var params = "status=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
	}


	function sendDownloadRequest(link){
		//document.downloadForm.submitButton.disabled = true;
		var params = "init=1&link="+link;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);

	//	return false;
	}
	
	function sendFinishRequest(){
		var params = "fin=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
	
	}

	function sendAbortRequest(){
		var params = "abort=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
		dlAborted = true;
	
	}

	function refreshView(){
		if(http.readyState == 4){
			var response = http.responseText;
			var args = response.split("@");
			// if(debug) document.getElementById('debugText').innerHTML = response;	
			//document.write(msgs[i]);
			
			if(args[0] == "suc"){
				activeDownload.progress =  Math.round(args[2]*10000) / 100; 
			}			
			
			if(args[0] == "fin"){
				activeDownload.progress = 100;
				activeDownload.link = args[2];
				activeDownload.complete = true 
			}
			if(args[0] == "abort"){
				activeDownload.aborted = true;
				return;
			}
			if(args[0] == "id"){
				activeDownload.id = args[1];
				statusRequestLoop();
			}
			
			displayTable();
		}
	}
	
	function selectAll(){
		var selectCount = 0;
		
		if(activeDownload == null && queue.length == 0)	return;
		
		if(activeDownload.selected) selectCount++; 
		activeDownload.selected= true;
		
		for(var i=0; i<queue.length; i++){
			if(queue[i].selected) selectCount++; 
			queue[i].selected = true;
		}
		
		if(selectCount == queue.length+1){
			activeDownload.selected = false;
			for(var i=0; i<queue.length; i++) queue[i].selected = false;
		}
		
		displayTable();
	}
	
	function displayTable(){
		if(activeDownload == null && queue.length == 0 && finishedDownloads.length == 0){
			document.getElementById('activeDownloadsTableContent').innerHTML = "Nothing to do...";
			return;
		}
		var table = "<form name='statusForm'><table style='color:#FFFFFF'><tr style='color:#FFFFFF;'><td width=70>";
		table += "<center><button type='button' onmousedown='selectAll();'> All</button></center></td><td width=300>File:</td><td>Progress:</td>";
		var selected = "" ;
		
		if(activeDownload != null){
			if(activeDownload.selected) selected="checked";
			else selected="";
			
			table += "<tr style='background-color:#4c4f4a'><td><div onmousedown='activeDownload.selected = !activeDownload.selected;'>";
			table += "<center><input type='checkbox'"+selected+"></center>"
			table += "<td>"+activeDownload.link+"</td><td>"+activeDownload.progress+" %</td></tr>";
		}
		for(var i=0; i<queue.length; i++){
			if(queue[i].selected) selected="checked";
			else selected="";
		
			var trstyle;
			if(i % 2 != 0) trstyle = "style='background-color:#4c4f4a;'";
			else trstyle = "";
			
			table += "<tr "+trstyle+"<td><div onmousedown='queue["+i+"].selected = !queue["+i+"].selected;'>";
			table += "<center><input type='checkbox'"+selected+"></center></div><td>"+queue[i].link+"</td><td style='color:#cdb21d;'>pending...</td></tr>";
		}

		for(var i=0; i<finishedDownloads.length; i++){
			var trstyle;
			var offset = 0;
			if(activeDownload != null) offset = 1;
			
			if((i+queue.length+offset-1) % 2 != 0) trstyle = "style='background-color:#4c4f4a;'";
			else trstyle = "";

			table += "<tr "+trstyle+"><td></td><td><a href='"+finishedDownloads[i].link+"'>"+finishedDownloads[i].link+"</a></td><td style='color:#66bd10;'>finished</td></tr>";
		}
		
		table += "</table></form>";
		document.getElementById('activeDownloadsTableContent').innerHTML = table;
	}
		
	function resetForm(){
		document.downloadForm.submitButton.disabled = false;
		document.downloadForm.abortButton.disabled = true;
		document.getElementById('progressText').innerHTML = "";
		dlStarted = false;
		dlComplete = false;
		dlAborted = false;
		abortRequestSent = false;
	}
	
	function abortDownloads(){
		var selectCount = 0;
		
		if(activeDownload.selected){
			selectCount++;
			sendAbortRequest();
		}
		
		for(var i=0; i<queue.length; i++){
			if(queue[i].selected){ 
				selectCount++;
				queue.splice(i,1);
				i--;
			}
			
		}
		
		if(!selectCount) alert("What to abort?");
	}
	

	

</script>

<p id="debugText"> </p>
<div id="Content" style="padding:0px 15px;">

<p id="progressText1"> </p>
<br>
<div id="activeDownloadsTableHead">
<p style="margin-top:4px; margin-left:8px;"> ActiveDownloads: </p>
</div>
<div id="activeDownloadsTable">
<div id="activeDownloadsTableContent" style="padding-left:16px; padding-top:8px;">
No downloads added yet...
</div>
</div>
<input type="text" id="linkinput" onkeydown="if (event.keyCode == 13) document.getElementById('submitButton').click();" value="rotnes.dk/carsten" size="40">

<table border="0">
<tr>
<td> <button id="submitButton" onClick="addDownload();">Send request</button> </td>
<td> <button name="abortButton" onClick="abortDownloads();" >Abort</button></td>
</tr>
</table>

<p id="progressText2"> </p>

</body>
</div>
</html>

