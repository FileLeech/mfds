<html>
<head>
<title>Multi-Filehoster-Leech</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<script type="text/javascript" src="DownloadModel.js"></script>
<script type="text/javascript">

	var http = createRequestObject();
	var dlStarted = false;
	var dlComplete = false;
	var dlAborted = false;
	var dlLink;
	//var downloads[0].id;
	var debug = true;
	
	var downloading = false;
	var activeDownload = null;
	var queue = new Array();
	var finishedDownloads = new Array();
	
	
	function addDownload(){
		var link = document.downloadForm.linkinput.value;
		var dl = new DownloadModel(link);
		dl.progress = 0 ;
		
		if(activeDownload == null) {
			activeDownload = dl;
			sendDownloadRequest(link);
		}
		else{
			queue.push(dl);
		}
	}

	

	function createRequestObject() {
		var objAjax;
		var browser = navigator.appName;
		if(browser == "Microsoft Internet Explorer"){
			objAjax = new ActiveXObject("Microsoft.XMLHTTP");
		}else{
			objAjax = new XMLHttpRequest();
		}
		return objAjax;
	}
	

	function statusRequestLoop() {
		if(activeDownload.complete) {
			sendFinishRequest();
			finishedDownloads.push(activeDownload);

			if(queue.length != 0){
				activeDownload = queue.shift();
				sendDownloadRequest(activeDownload.link);
				return;
			}
			else{
				activeDownload = null;
				return;
			}
		}
	
		if(activeDownload.aborted) {
			setTimeout('resetForm()',1000);
			return;
		}
	
		
				
		setTimeout('statusRequestLoop()',500);
		var params = "status=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
	}


	function sendDownloadRequest(link){
		//document.downloadForm.submitButton.disabled = true;
		var params = "init=1&link="+link;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);

		return false;
	}
	
	function sendFinishRequest(){
		var params = "fin=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
	
	}

	function sendAbortRequest(){
		var params = "abort=1&id="+activeDownload.id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
		dlAborted = true;
	
	}

	function refreshView(){
		if(http.readyState == 4){
			var response = http.responseText;
			var args = response.split("@");
			// if(debug) document.getElementById('debugText').innerHTML = response;	
			//document.write(msgs[i]);
			
			if(args[0] == "suc"){
				activeDownload.progress =  Math.round(args[2]*10000) / 100; 
			}			
			
			if(args[0] == "fin"){
				activeDownload.progress = 100;
				activeDownload.link = args[2];
				activeDownload.complete = true 
			}
			if(args[0] == "abort"){
				dlAborted = true;
			}
			if(args[0] == "id"){
				activeDownload.id = args[1];
				statusRequestLoop();
			}
			
			displayTable();
		}
	}
	
	function displayTable(){
		 var table = "<table style='color:#d52908'>";
		
		if(activeDownload != null)
			table += "<tr><td>"+activeDownload.link+"</td><td> (</td><td>"+activeDownload.progress+" % )</td></tr>";

		for(var i=0; i<queue.length; i++){
			table += "<tr><td>"+queue[i].link+"</td><td> (</td><td> queued)</td></tr>";
		}

		for(var i=0; i<finishedDownloads.length; i++){
			table += "<tr><td><a href='"+finishedDownloads[i].link+"'>"+finishedDownloads[i].link+"</a></td><td>  (</td><td>finished)</td></tr>";
		}
		
		table += "</table>";
		document.getElementById('activeDownloadsTableContent').innerHTML = table;
	}
		
	function resetForm(){
		document.downloadForm.submitButton.disabled = false;
		document.downloadForm.abortButton.disabled = true;
		document.getElementById('progressText').innerHTML = "";
		dlStarted = false;
		dlComplete = false;
		dlAborted = false;
		abortRequestSent = false;
	}
	

</script>

<p id="debugText"> </p>
<div id="Content" style="padding:0px 15px;">

<p id="progressText1"> </p>
<br>
<div id="activeDownloadsTableHead">
<p style="margin-top:4px; margin-left:8px;"> ActiveDownloads: </p>
</div>
<div id="activeDownloadsTable">
<div id="activeDownloadsTableContent" style="padding-left:8px; padding-top:4px;"></div>
</div>
<form style="margin-top:15px;" name="downloadForm">
<input type="text" name="linkinput" value="rotnes.dk/carsten" size="40"></textarea>
<table border="0" cellspacing="0" cellpadding="5">
<tr>
<td> <input name="submitButton" type="button" value="Send request" onClick="addDownload();"></td>
<td> <input name="abortButton" type="button" value="Abort" onClick="abortDownload();" disabled="disabled"></td>
</tr>
</table>
</form>


<p id="progressText2"> </p>


</body>
</div>
</html>

