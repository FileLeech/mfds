<html>
<head>
<title>Ajax-driven Engine ftw!!!</title>
<script type="text/javascript">

	var http = createRequestObject();
	var dlStarted = false;
	var dlComplete = false;
	var dlAborted = false;
	var dlLink;
	var dlID;
	var debug = true;
	
	document.downloadForm.linkinput.value = "rotnes.dk/catsen";
	
	function createRequestObject() {
		var objAjax;
		var browser = navigator.appName;
		if(browser == "Microsoft Internet Explorer"){
			objAjax = new ActiveXObject("Microsoft.XMLHTTP");
		}else{
			objAjax = new XMLHttpRequest();
		}
		return objAjax;
	}

	function sendStatusRequest() {
		if(dlComplete) {
			sendFinishRequest();
			return;
		}
		
		if(dlAborted) {
			cleanup();		
			return;
		}
		
		setTimeout('sendStatusRequest()',250);
		var params = "id="+dlID;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);

	}


	function sendDownloadRequest(){
		document.downloadForm.submitButton.disabled = true;
		
		dlLink = document.downloadForm.linkinput.value;
		var params = "link="+dlLink;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		return false;
	}
	
	function sendFinishRequest(){
		var params = "fin=1&id="+dlID;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
	
	
	}

	function sendAbortRequest(){
		var params = "abort=1&id="+dlID;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
	
	}

	function refreshView(){
		if(http.readyState == 4){
			var response = http.responseText;
			var args = response.split(" ");
			
			//	if(debug) document.getElementById('debugText').innerHTML = response;	
			
			if(args[0] == "suc"){
				var progress = Math.round(args[1]*10000) / 100;
				document.getElementById('progressText').innerHTML = "Progress: "+progress+" %";
			}
			if(args[0] == "fin"){
				document.getElementById('progressText').innerHTML = "Finished: <a href="+args[1]+">"+args[1]+"</a>";
				dlComplete = true;
			}
			if(args[0] == "abort"){
				dlAborted = true;
			}
			if(!dlStarted){
				dlStarted = true;
				dlID = http.responseText;
				sendStatusRequest();
				document.downloadForm.abortButton.disabled = false;
			}
		}
	}
	
	function cleanup(){
		document.downloadForm.submitButton.disabled = false;
		document.downloadForm.abortButton.disabled = true;
		document.getElementById('progressText').innerHTML = "";
		dlStarted = false;
		dlComplete = false;
		dlAborted = false;
	}
	

</script>

<form name="downloadForm">
<input type="text" name="linkinput" value="rotnes.dk/carsten" size=40"></textarea>
<table border="0" cellspacing="0" cellpadding="5">
<tr>
<td> <input name="submitButton" type="button" value="Send request" onClick="sendDownloadRequest();"></td>
<td> <input name="abortButton" type="button" value="Abort" onClick="sendAbortRequest();" disabled="disabled"></td>
</tr>
</table>
</form>

<p id="progressText"> </p>
<br><br>

</head>
<body>
<p id="debugText"> </p>
 <div id="Content"></div>
</body>
</html>

