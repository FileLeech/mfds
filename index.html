<html>
<head>
<title>Multi-Filehoster-Leech</title>
<link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
<script type="text/javascript" src="DownloadModel.js"></script>
<script type="text/javascript">

	var http = createRequestObject();
	var dlStarted = false;
	var dlComplete = false;
	var dlAborted = false;
	var dlLink;
	//var downloads[0].id;
	var debug = true;
	
	var downloading = false;
	var downloads = new Array();
	var queue = new Array();
	var finishedDownloads = new Array();
	
	
	function addDownload(){
		var link = document.downloadForm.linkinput.value;
		var dl = new DownloadModel(link);
		dl.progress = 0 ;
		
		if(downloads.length == 0) {
			downloads[downloads.length] = dl;
			sendDownloadRequest(link);
		}
		else{
			queue.push(dl);
		
		}
	}

	

	function createRequestObject() {
		var objAjax;
		var browser = navigator.appName;
		if(browser == "Microsoft Internet Explorer"){
			objAjax = new ActiveXObject("Microsoft.XMLHTTP");
		}else{
			objAjax = new XMLHttpRequest();
		}
		return objAjax;
	}
	

	function statusRequestLoop() {
		for(var i=0; i<downloads.length; i++){	
			var dl = downloads[i];
			
			if(dl.complete) {
				sendFinishRequest();
				var tmp = downloads.splice(i,1);
				finishedDownloads.push(tmp[0])
				if(queue.length != 0){
					downloads[0] = queue.shift();
					sendDownloadRequest(downloads[0].link);
				}
				return;
			}
		
			if(dl.aborted) {
				setTimeout('resetForm()',1000);
				return;
			}
		
		}
		
				
		setTimeout('statusRequestLoop()',500);
		var params = "status=1&ids=";
		
		for(var i=0; i<downloads.length; i++){
			var dl = downloads[i]
			params += dl.id;
			if(i != downloads.length-1) params += ",";
		}


		//if(downloads.length < 1 && i == 0) continue;
		 
		//var params = "status=1&id="+downloads[i].id;

		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
	}


	function sendDownloadRequest(link){
		//document.downloadForm.submitButton.disabled = true;

		var params = "init=1&link="+link;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		return false;
	}
	
	function sendFinishRequest(){
		var params = "fin=1&id="+downloads[0].id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
	
	}

	function sendAbortRequest(){
		var params = "abort=1&id="+downloads[0].id;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		
		dlAborted = true;
	
	}

	function refreshView(){
		if(http.readyState == 4){
			var response = http.responseText;
			var msgs = response.split("\n");
			


			for(var i=0; i<msgs.length; i++){
				var args = msgs[i].split("@");
			
				// if(debug) document.getElementById('debugText').innerHTML = response;	
				//document.write(msgs[i]);
				
				if(args[0] == "suc"){
					for(var j=0; j<downloads.length; j++){	
						dl=downloads[j];
						if(args[1] == dl.id){
							dl.progress =  Math.round(args[2]*10000) / 100; 
						}
					}
				}
				
				if(args[0] == "fin"){
					for(var j=0; j<downloads.length; j++){	
						dl=downloads[j];
						if(args[1] == dl.id){
							dl.progress = 100;
							dl.link = args[2];
							dl.complete = true 
						}
					}
				}
				if(args[0] == "abort"){
					dlAborted = true;
				}
				if(args[0] == "id"){
					alert(args[1]);

					for(var i=0; i<downloads.length; i++){
						var dl = downloads[i];
						if(dl.link == args[2]){
							downloads[i].id = args[1];
							statusRequestLoop();
						}
					}
				}
			}
			
			displayTable();
		}
	}
	
	function displayTable(){
		 var table = "<table style='color:#d52908'>";
		
		for(var i=0; i<downloads.length; i++){
			table += "<tr><td>"+downloads[i].link+"</td><td> (</td><td>"+downloads[i].progress+" % )</td></tr>";
		}

		for(var i=0; i<queue.length; i++){
			table += "<tr><td>"+queue[i].link+"</td><td> (</td><td> queued)</td></tr>";
		}

		for(var i=0; i<finishedDownloads.length; i++){
			table += "<tr><td><a href='"+finishedDownloads[i].link+"'>"+finishedDownloads[i].link+"</a></td><td>  (</td><td>finished)</td></tr>";
		}
		
		table += "</table>";
		document.getElementById('activeDownloadsTableContent').innerHTML = table;
	}
		
	function resetForm(){
		document.downloadForm.submitButton.disabled = false;
		document.downloadForm.abortButton.disabled = true;
		document.getElementById('progressText').innerHTML = "";
		dlStarted = false;
		dlComplete = false;
		dlAborted = false;
		abortRequestSent = false;
	}
	

</script>

<p id="debugText"> </p>
<div id="Content" style="padding:0px 15px;">

<p id="progressText1"> </p>
<br>
<div id="activeDownloadsTableHead">
<p style="margin-top:4px; margin-left:8px;"> ActiveDownloads: </p>
</div>
<div id="activeDownloadsTable">
<div id="activeDownloadsTableContent" style="padding-left:8px; padding-top:4px;"></div>
</div>
<form style="margin-top:15px;" name="downloadForm">
<input type="text" name="linkinput" value="rotnes.dk/carsten" size="40"></textarea>
<table border="0" cellspacing="0" cellpadding="5">
<tr>
<td> <input name="submitButton" type="button" value="Send request" onClick="addDownload();"></td>
<td> <input name="abortButton" type="button" value="Abort" onClick="abortDownload();" disabled="disabled"></td>
</tr>
</table>
</form>


<p id="progressText2"> </p>


</body>
</div>
</html>

