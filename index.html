<html>
<head>
<title>Ajax-driven Engine ftw!!!</title>
<script type="text/javascript">

	var http = createRequestObject();
	var dlStarted = false;
	var dlID;
	
	function createRequestObject() {
		var objAjax;
		var browser = navigator.appName;
		if(browser == "Microsoft Internet Explorer"){
			objAjax = new ActiveXObject("Microsoft.XMLHTTP");
		}else{
			objAjax = new XMLHttpRequest();
		}
		return objAjax;
	}

	function getDlStatus() {
		setTimeout('getDlStatus()',125);
		var params = "id="+dlID;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);

	}


	function activateDownload(){
		var params = "link="+document.downloadForm.outputtext.value;
		
		http.open('POST','download.php');
		http.onreadystatechange = refreshView;

		//Send the proper header information along with the request
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", params.length);
		http.setRequestHeader("Connection", "close");

		http.send(params);
		return false;
	}

	function refreshView(){
		if(http.readyState == 4){
			var response = http.responseText;
			var args = response.split(" ");
			
			if(args[0] == "suc"){
				var progress = Math.round(args[1]*10000) / 100;
				document.getElementById('mySentence').innerHTML = "Progress: "+progress+" %";
			}
			if(!dlStarted){
				dlStarted = true;
				dlID = http.responseText;
				getDlStatus();
			}
		}
	}
	

</script>

<form name="downloadForm">
<table border="0" cellspacing="0" cellpadding="5">
<tr>
<td><textarea name="outputtext"></textarea></td>
</tr>
<tr>
<td> <input type="button" value="Send request" onClick="activateDownload();"></p>
</tr>
</table>
</form>

<p id="mySentence">
</p>

</head>
<body>
 <div id="Content"></div>
</body>
</html>

